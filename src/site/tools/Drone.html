<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drone Synth</title>

    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at top left, #ffb347, #5a2c14);
            font-family: "Trebuchet MS", sans-serif;
            touch-action: none;
        }

        .pedal {
            width: 90vw;
            max-width: 360px;
            height: 540px;
            background: linear-gradient(145deg, #7a3b1a, #4b1f0d);
            border-radius: 22px;
            box-shadow:
                inset 0 0 0 4px #2a1207,
                0 20px 40px rgba(0, 0, 0, 0.5);
            padding: 20px;
            position: relative;
        }

        .pedal::before {
            content: "";
            position: absolute;
            inset: 10px;
            border-radius: 16px;
            background:
                repeating-radial-gradient(circle,
                    rgba(255, 165, 0, 0.08) 0px,
                    rgba(255, 165, 0, 0.08) 4px,
                    transparent 4px,
                    transparent 8px);
            pointer-events: none;
        }

        .title {
            text-align: center;
            color: #ffb347;
            font-size: 22px;
            letter-spacing: 3px;
            text-shadow: 2px 2px 0 #2a1207;
        }

        .tracker {
            text-align: center;
            color: #ffcf87;
            font-size: 22px;
            letter-spacing: 3px;
            text-shadow: 2px 2px 0 #2a1207;
            margin: 6px 0 12px;
        }

        .display {
            margin: 0 auto 16px;
            width: 200px;
            height: 40px;
            background: linear-gradient(180deg, #1b1b1b, #000);
            border-radius: 6px;
            box-shadow:
                inset 0 0 6px rgba(0, 255, 180, 0.4),
                0 2px 4px rgba(0, 0, 0, 0.6);
            color: #6affc9;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .knob-area {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 26px 16px;
            justify-items: center;
            min-height: 300px;
        }

        .knob {
            width: 82px;
            height: 82px;
            border-radius: 50%;
            position: relative;
            touch-action: none;
            background:
                radial-gradient(circle at 30% 30%, #f6f6f6, #cfcfcf 45%, #9b9b9b 70%, #6b6b6b);
            box-shadow:
                inset -6px -6px 10px rgba(0, 0, 0, 0.35),
                inset 6px 6px 10px rgba(255, 255, 255, 0.6),
                0 6px 10px rgba(0, 0, 0, 0.6);
            transform: rotate(-135deg);
        }

        .knob::before {
            content: "";
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            background:
                repeating-conic-gradient(rgba(0, 0, 0, 0.18) 0deg 6deg,
                    transparent 6deg 12deg);
            mask: radial-gradient(circle, transparent 55%, black 56%);
        }

        .knob::after {
            content: "";
            position: absolute;
            top: 6px;
            left: 50%;
            width: 4px;
            height: 18px;
            background: #2a1207;
            border-radius: 2px;
            transform: translateX(-50%);
        }

        .cap {
            position: absolute;
            inset: 28px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #555, #222);
        }

        .controls {
            position: absolute;
            bottom: 20px;
            width: calc(100% - 40px);
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            background: #ff8c00;
            color: #3a1808;
            border: none;
            padding: 12px;
            font-size: 18px;
            letter-spacing: 3px;
            border-radius: 10px;
            cursor: pointer;
            /* box-shadow: 0 4px 0 #9a4f00; */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        button:hover {
            box-shadow: 0 16px 32px 0 rgba(0, 0, 0, 0.6);
        }

        /* button:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #9a4f00;
        } */
    </style>
</head>

<body>

    <div class="pedal">
        <div class="title">DRONE SYNTH</div>
        <div class="tracker" id="tracker">0 / 4</div>

        <div class="display" id="displayText">ADD A KNOB</div>

        <div class="knob-area" id="knobArea"></div>

        <div class="controls">
            <button id="addBtn">+ Knob</button>
            <button id="removeBtn">− Knob</button>
        </div>
    </div>

    <script>
        const knobArea = document.getElementById("knobArea");
        const tracker = document.getElementById("tracker");
        const addBtn = document.getElementById("addBtn");
        const removeBtn = document.getElementById("removeBtn");

        const MAX_KNOBS = 4;

        // Array of knob objects { element, frameId, value }
        const knobs = [];

        function updateTracker() {
            tracker.textContent = `${knobs.length} / ${MAX_KNOBS}`;
        }

        // Add knob
        function addKnob() {
            if (knobs.length >= MAX_KNOBS) return;

            const knob = document.createElement("div");
            knob.className = "knob";

            const cap = document.createElement("div");
            cap.className = "cap";
            knob.appendChild(cap);

            knobArea.appendChild(knob);

            const knobObj = { element: knob, frameId: null, value: 0 };
            knobs.push(knobObj);

            enableSmoothKnob(knobObj);

            updateTracker();
        }

        // Remove knob
        function removeKnob() {
            if (knobs.length === 0) return;

            const knobObj = knobs.pop();

            // cancel animation
            if (knobObj.frameId) cancelAnimationFrame(knobObj.frameId);

            // reset value
            knobObj.value = 0;

            knobArea.removeChild(knobObj.element);

            updateTracker();

            if (knobs.length == 0) {
                document.getElementById("displayText").textContent = "ADD A KNOB";
                stopLastOsc();
            }
            //console.log(knobs);
            //logKnobs();
        }

        function useKnobValues() {
            const knob1 = knobs[0] ? knobs[0].value : 0;
            const knob2 = knobs[1] ? knobs[1].value : 0;
            const knob3 = knobs[2] ? knobs[2].value : 0;
            const knob4 = knobs[3] ? knobs[3].value : 0;

            // Do something with them
            //console.log("Knob1:", knob1, "Knob2:", knob2, "Knob3:", knob3, "Knob4:", knob4);

            // Example: return values as an object
            return { knob1, knob2, knob3, knob4 };
        }

        function doSomethingWithKnobs() {
            const { knob1, knob2, knob3, knob4 } = useKnobValues();
            // example action:
            const average = (knob1 + knob2 + knob3 + knob4) / 4;
            //console.log("Average knob value:", average);
            document.getElementById("displayText").textContent = "OSCILLATORS ACTIVE";
            handleKnob(0, knob1);
            handleKnob(1, knob2);
            handleKnob(2, knob3);
            handleKnob(3, knob4);
        }

        //this gets called on animate, put any steps you want knobs to do here
        function OnUpdateKnobs() {
            doSomethingWithKnobs();
        }

        // Enable knob rotation
        function enableSmoothKnob(knobObj) {
            const knob = knobObj.element;
            let dragging = false;
            let startPointerAngle = 0;
            let startKnobAngle = -135;
            let currentAngle = -135;
            let targetAngle = -135;

            function getPointerAngle(e) {
                const rect = knob.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                return Math.atan2(e.clientY - cy, e.clientX - cx) * 180 / Math.PI;
            }

            knob.addEventListener("pointerdown", e => {
                dragging = true;
                knob.setPointerCapture(e.pointerId);
                startPointerAngle = getPointerAngle(e);
                startKnobAngle = targetAngle;
            });

            knob.addEventListener("pointerup", () => dragging = false);
            knob.addEventListener("pointercancel", () => dragging = false);

            knob.addEventListener("pointermove", e => {
                if (!dragging) return;
                let delta = getPointerAngle(e) - startPointerAngle;
                if (delta > 180) delta -= 360;
                if (delta < -180) delta += 360;

                targetAngle = Math.max(-135, Math.min(135, startKnobAngle + delta));
            });

            function animate() {
                currentAngle += (targetAngle - currentAngle) * 0.18;
                knob.style.transform = `rotate(${currentAngle}deg)`;

                knobObj.value = Math.round(((currentAngle + 135) / 270) * 100);

                OnUpdateKnobs();

                knobObj.frameId = requestAnimationFrame(animate);
            }
            animate();
        }

        // Mobile fix buttons
        addBtn.addEventListener("pointerdown", e => { e.preventDefault(); addKnob(); ensureAudioContext(); if (ctx.state === "suspended") ctx.resume(); });
        removeBtn.addEventListener("pointerdown", e => { e.preventDefault(); removeKnob(); ensureAudioContext(); if (ctx.state === "suspended") ctx.resume(); });

        //audio stuff
        let ctx;
        const OSC_COUNT = 4;
        const oscillators = [];
        const gains = [];

        // start AudioContext
        function ensureAudioContext() {
            if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        }

        // Initialize oscillator + gain for index i
        function initOscillator(i, freq = 440) {
            ensureAudioContext();
            if (ctx.state === "suspended") {
                ctx.resume().then(() => initOscillator(i, freq)); // try again after resume
            }

            if (!oscillators[i]) {
                const osc = ctx.createOscillator();
                osc.type = "triangle";
                osc.frequency.value = freq;

                const gain = ctx.createGain();
                gain.gain.value = 0; // start silent

                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.start();

                oscillators[i] = osc;
                gains[i] = gain;
            }
        }

        // Handle knob movement
        function handleKnob(knobIndex, currentAngle) {
            //use knob angle as cuurent angle, sort of oddly named but the knob "goes from 0 to 100"
            const knobValue = currentAngle;

            // Initialize oscillator if needed
            initOscillator(knobIndex);

            if (knobValue === 0) {
                // Silent if knob is zero
                gains[knobIndex].gain.setValueAtTime(0, ctx.currentTime);
            } else {
                // Map knob 0–100 → 100–500 Hz
                const freq = 200 + (knobValue / 100) * 600;
                // Set frequency and turn on
                oscillators[knobIndex].frequency.setValueAtTime(freq, ctx.currentTime);
                gains[knobIndex].gain.setValueAtTime(1, ctx.currentTime);
            }
        }

        //failsafe function
        function stopLastOsc() {
            gains[0].gain.setValueAtTime(0, ctx.currentTime);
        }
        //I know your reading this, you know who you are :)
    </script>

</body>

</html>